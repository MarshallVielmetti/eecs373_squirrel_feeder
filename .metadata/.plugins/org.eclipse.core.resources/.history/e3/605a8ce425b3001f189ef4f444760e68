#include "main.h"

#include "integration.h"

#include "ili9341.h"
#include "fonts.h"
#include "test_squirrel_1.h"
#include "test_squirrel_2.h"
#include "test_umich_1.h"

#include <stdio.h>
#include <string.h>
#include <stdarg.h>
//
extern SPI_HandleTypeDef hspi3;
extern TIM_HandleTypeDef LCD_TIMER_HANDLE;

static const Feeder* lcd_feeder_ref;

enum LcdStateType {
	SQUIRREL_CLIP,
	SQUIRREL_RES,
	M_LOGO,
	STATISTICS,
	OUT_OF_FOOD_WARNING
} LcdState;

void lcd_init(const Feeder* feeder) {
	ILI9341_Unselect();
	ILI9341_Init();

	lcd_feeder_ref = feeder;
}

void lcd_isr() {
	lcd_between();

	if (feeder->state == OUT_OF_FOOD) {
		LcdState = OUT_OF_FOOD_WARNING;
	}

	switch(LcdState) {
	case SQUIRREL_CLIP:
		squirrel_clip();
		break;
	case SQUIRREL_RES:
		squirrel_res();
		break;
	case M_LOGO:
		m_logo();
		break;
	case STATISTICS:
		display_stats();
		break;
	case OUT_OF_FOOD_WARNING:
		display_out_of_food();
		break;
	}

}



void squirrel_clip() {
	ILI9341_DrawImage((ILI9341_WIDTH - 320)/2,(ILI9341_HEIGHT-240)/2,320,240,(const uint16_t*)squirrelclip);
}

void squirrel_res() {
	ILI9341_DrawImage((ILI9341_WIDTH - 320)/2,(ILI9341_HEIGHT-213)/2,320,213,(const uint16_t*)squirrelres);
}

void m_logo() {
	ILI9341_DrawImage((ILI9341_WIDTH - 320)/2,(ILI9341_HEIGHT-203)/2,320,203,(const uint16_t*)MLogo);
}

void display_stats(int weight, int squirrel_count) {
	const char* team1 = "FEED";
	const char* team2 = "THE";
	const char* team3 = "SQUIRRELS";
	const char* class = "FROM EECS 373";
	const char* linebrk = "-*-*-*-*-*-";

	// Needs help
	char strSquirrels[4];
	sprintf(strSquirrels, "%d", squirrel_count);
	char strWeight[4];
	sprintf(strWeight, "%d", weight);

	const char* squcount = strcat("Squirrels Fed: ", strSquirrels);
	const char* flevels = strcat("Food Dispensed: ", strWeight);

	// FEED THE SQUIRRELS FROM EECS 383 -*-*-*-*-*
	ILI9341_WriteString(10, 10, team1, Font_16x26, ILI9341_YELLOW, ILI9341_BLUE);
	ILI9341_WriteString(10, 40, team2, Font_16x26, ILI9341_YELLOW, ILI9341_BLUE);
	ILI9341_WriteString(10, 70, team3, Font_16x26, ILI9341_YELLOW, ILI9341_BLUE);
	ILI9341_WriteString(10, 100, class, Font_11x18, ILI9341_YELLOW, ILI9341_BLUE);
	ILI9341_WriteString(10, 130, linebrk, Font_11x18, ILI9341_YELLOW, ILI9341_BLUE);

	// Squirrels Fed: squcount
	// Food Dispensed: strWeight
	ILI9341_WriteString(10, 160, squcount, Font_11x18, ILI9341_YELLOW, ILI9341_BLUE);
	ILI9341_WriteString(10, 190, flevels, Font_11x18, ILI9341_YELLOW, ILI9341_BLUE);
}

void display_out_of_food() {
	const char* OUT_OF_FOOD = "!! OUT OF FOOD !!";
	ILI9341_WriteString(10, 70, OUT_OF_FOOD, Font_16x26, ILI9341_YELLOW, ILI9341_BLUE);
}


void lcd_between(){
//	HAL_Delay(1000);
	ILI9341_FillScreen(ILI9341_WHITE);
}
